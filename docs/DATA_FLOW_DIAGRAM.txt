```
┌─────────────────────────────────────────────────────────────────────────┐
│                      Real-time Data Flow Architecture                    │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  STEP 1: Data Collection from Mobile App                                 │
└─────────────────────────────────────────────────────────────────────────┘

    ┌────────────────────┐
    │  Guotai Mobile App │
    │  (国泰海通君弘)      │
    └──────────┬─────────┘
               │
               │ ADB + DroidRun
               │ (Vision + LLM)
               ▼
    ┌────────────────────┐
    │  DroidAgent        │
    │  - Screenshot      │
    │  - OCR/Vision      │
    │  - Goal-based AI   │
    └──────────┬─────────┘
               │
               │ Extract & Format
               ▼

┌─────────────────────────────────────────────────────────────────────────┐
│  STEP 2: CSV Format Data Output                                          │
└─────────────────────────────────────────────────────────────────────────┘

    ┌──────────────────────────────┐  ┌──────────────────────────────┐
    │  Quote Page CSV              │  │  Position Page CSV           │
    │  ──────────────              │  │  ──────────────             │
    │  • Market Indices:           │  │  • Portfolio Summary:        │
    │    - Index Name              │  │    - 浮动盈亏 (Float P&L)    │
    │    - Index Number            │  │    - 账户资产 (Total Assets) │
    │    - Index Ratio             │  │    - 总市值 (Market Value)   │
    │                              │  │    - 仓位 (Position %)       │
    │  • Stock Quotes:             │  │    - 可用 (Available)        │
    │    - Stock_Name(Code)        │  │    - 可取 (Withdrawable)     │
    │    - Latest_Price            │  │                              │
    │    - Increase_%              │  │  • Stock Positions:          │
    │    - Increase_Amount         │  │    - stock_name              │
    └──────────┬───────────────────┘  │    - market_cap              │
               │                      │    - open/available          │
               │                      │    - current_price           │
               └──────────────────────┤    - cost                    │
                                      │    - floating_profit         │
                                      │    - floating_loss(%)        │
                                      └──────────┬───────────────────┘
                                                 │
                                                 ▼

┌─────────────────────────────────────────────────────────────────────────┐
│  STEP 3: Data Parsing & Transformation                                   │
└─────────────────────────────────────────────────────────────────────────┘

            ┌────────────────────────────────────────┐
            │  save_app_data_to_db()                 │
            │  ──────────────────────                │
            │  1. parse_csv_data()                   │
            │     → Split headers & rows             │
            │                                        │
            │  2. extract_stock_code()               │
            │     → "中科三环(000970)" → name, code  │
            │                                        │
            │  3. parse_percentage()                 │
            │     → "+1.21%" → 1.21                  │
            │                                        │
            │  4. parse_number()                     │
            │     → "+0.17" → 0.17                   │
            └────────────────┬───────────────────────┘
                             │
                             ▼

┌─────────────────────────────────────────────────────────────────────────┐
│  STEP 4: Database Operations (SQLite with Transactions)                  │
└─────────────────────────────────────────────────────────────────────────┘

        ┌────────────────────────────────────────────┐
        │  SQLite Transaction BEGIN                   │
        └────────────────┬───────────────────────────┘
                         │
         ┌───────────────┼───────────────┐
         │               │               │
         ▼               ▼               ▼
    ┌────────┐     ┌──────────┐    ┌──────────┐
    │ market │     │  total   │    │  stocks  │
    │_indices│     │ _table   │    │ _table   │
    └────┬───┘     └────┬─────┘    └────┬─────┘
         │              │               │
         │ UPSERT       │ UPSERT        │ UPDATE/INSERT
         │              │               │
         │              │               │
    ┌────▼──────────────▼───────────────▼────┐
    │  Fields Updated:                        │
    │  ────────────────                       │
    │  • index_name, current_value            │
    │  • total_assets, market_value           │
    │  • position_percent ⭐ NEW              │
    │  • withdrawable ⭐ NEW                  │
    │  • available_shares ⭐ NEW              │
    │  • last_updated ⭐ NEW                  │
    └────────────────┬────────────────────────┘
                     │
                     ▼
        ┌────────────────────────────────────────────┐
        │  SQLite Transaction COMMIT                  │
        │  (or ROLLBACK on error)                     │
        └────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  STEP 5: Result & Reporting                                               │
└─────────────────────────────────────────────────────────────────────────┘

        ┌────────────────────────────────────────────┐
        │  Return Result Dictionary                   │
        │  ─────────────────────────                 │
        │  {                                         │
        │    'success': True/False,                  │
        │    'message': "...",                       │
        │    'indices_updated': 3,                   │
        │    'stocks_updated': 15,                   │
        │    'total_updated': True                   │
        │  }                                         │
        └────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  Database Schema Changes                                                  │
└─────────────────────────────────────────────────────────────────────────┘

    BEFORE                          AFTER (New Fields ⭐)
    ──────                          ─────────────────────

    ┌─────────────┐                 ┌─────────────┐
    │ total_table │                 │ total_table │
    ├─────────────┤                 ├─────────────┤
    │ • user_id   │                 │ • user_id   │
    │ • total_mv  │                 │ • total_mv  │
    │ • cash      │                 │ • cash      │
    │ • pnl_float │                 │ • pnl_float │
    │ • ...       │                 │ • ...       │
    └─────────────┘                 │ ⭐ position_percent
                                    │ ⭐ withdrawable
                                    │ ⭐ last_updated
                                    └─────────────┘

    ┌──────────────┐                ┌──────────────┐
    │ stocks_table │                │ stocks_table │
    ├──────────────┤                ├──────────────┤
    │ • code       │                │ • code       │
    │ • name       │                │ • name       │
    │ • holdings   │                │ • holdings   │
    │ • ...        │                │ • ...        │
    └──────────────┘                │ ⭐ available_shares
                                    │ ⭐ last_updated
                                    └──────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│  Error Handling Flow                                                      │
└─────────────────────────────────────────────────────────────────────────┘

    ┌─────────────┐
    │  Try Block  │
    └──────┬──────┘
           │
           ├─→ Parse Error? ──→ Skip row, continue
           │
           ├─→ DB Error? ────→ ROLLBACK transaction
           │                  └→ Return error details
           │
           └─→ Success ──────→ COMMIT transaction
                              └→ Return success stats

═══════════════════════════════════════════════════════════════════════════

Legend:
  ⭐ = New field/feature added
  → = Data flow direction
  ├─→ = Decision branch
  └─→ = Result/output

═══════════════════════════════════════════════════════════════════════════
```
